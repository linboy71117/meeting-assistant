<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ’¡ äº’å‹•å¼æœƒè­°åˆ†æåŠ©ç† - ææ¡ˆé é¢</title>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f4f7f6; color: #333; }
        .container { max-width: 900px; margin: auto; background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        #meeting-topic { color: #dc3545; text-align: center; margin-bottom: 20px; font-size: 1.8em; padding: 10px; background-color: #fff3f5; border-radius: 8px;}
        .input-group { display: flex; gap: 10px; margin-bottom: 20px; }
        #proposal-input { flex-grow: 1; padding: 12px; border: 1px solid #ccc; border-radius: 6px; resize: vertical; min-height: 80px; }
        #user-name { width: 150px; padding: 12px; border: 1px solid #ccc; border-radius: 6px; }
        button { padding: 10px 20px; background-color: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; transition: background-color 0.3s; }
        button:hover { background-color: #218838; }
        .reset-button { background-color: #dc3545; }
        .reset-button:hover { background-color: #c82333; }
        .section { margin-top: 30px; padding: 20px; border: 1px dashed #007bff; border-radius: 8px; background-color: #e9f7ff; }
        #analysis-output { white-space: pre-wrap; background: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; border-radius: 6px; min-height: 200px; }
        .proposal-list { list-style: none; padding: 0; }
        .proposal-list li { background: #f0f0f0; margin-bottom: 8px; padding: 10px; border-left: 5px solid #007bff; border-radius: 4px; font-size: 0.9em; }
    </style>
</head>
<body>
    <div class="container">
        <h2 id="meeting-topic">è¼‰å…¥ä¸­...</h2>

        <h2>æäº¤æ‚¨çš„ææ¡ˆ</h2>
        <div class="input-group">
            <input type="text" id="user-name" placeholder="æ‚¨çš„åå­— (é¸å¡«ï¼Œé è¨­åŒ¿å)" value="çµ„å“¡A">
            <input type="text" id="user-input-topic" placeholder="è«‹å†ç¢ºèªæ‚¨å°æœ¬æ¬¡ææ¡ˆçš„æ¨™é¡Œ" value="">
        </div>
        <div class="input-group">
            <textarea id="proposal-input" placeholder="è«‹è¼¸å…¥æ‚¨å°å°ˆé¡Œæˆ–ä¸»é¡Œçš„å…·é«”æƒ³æ³•..."></textarea>
        </div>
        <button onclick="submitProposal()">æäº¤ææ¡ˆ</button>
        <button onclick="getAnalysis(true)">å³æ™‚åˆ†ææ‰€æœ‰ææ¡ˆ (èª¿ç”¨ Gemini)</button>
        <button class="reset-button" onclick="resetSession()">çµæŸ/é‡ç½®æœƒè­°</button>

        <div class="section">
            <h3>ğŸ“ å·²æäº¤çš„ææ¡ˆ</h3>
            <ul id="proposal-list" class="proposal-list">
                </ul>
        </div>

        <div class="section">
            <h3>ğŸ¤– Gemini å°ˆæ¥­åˆ†æèˆ‡è³ªç–‘</h3>
            <pre id="analysis-output">è«‹æäº¤ææ¡ˆå¾Œé»æ“Šã€Œå³æ™‚åˆ†æã€æŒ‰éˆ•ã€‚</pre>
        </div>
    </div>

    <script>
        let proposalCount = 0;
        let currentTopic = "è¼‰å…¥ä¸­..."; // å„²å­˜ç•¶å‰ä¸»é¡Œ

        /**
         * ç²å–ä¸¦é¡¯ç¤ºç•¶å‰æœƒè­°ä¸»é¡Œ
         */
        async function getTopic() {
            try {
                const response = await fetch('/get_current_topic');
                const data = await response.json();
                const topicElement = document.getElementById('meeting-topic');
                
                if (data.active) {
                    currentTopic = data.topic;
                    topicElement.innerHTML = `ä¸»é¡Œï¼š<strong>${data.topic}</strong>`;
                } else {
                    topicElement.innerHTML = `<strong>ç„¡æ´»èºæœƒè­°</strong>`;
                    alert('ç›®å‰æ²’æœ‰æ´»èºçš„è…¦åŠ›æ¿€ç›ªæœƒè­°ï¼Œå°‡å°å‘ç™¼èµ·é é¢ã€‚');
                    window.location.href = '/';
                }
            } catch (error) {
                console.error('Error fetching topic:', error);
                document.getElementById('meeting-topic').innerHTML = `ä¸»é¡Œï¼š<strong>è¼‰å…¥éŒ¯èª¤</strong>`;
            }
        }

        /**
         * æäº¤ææ¡ˆåˆ°å¾Œç«¯
         */
        async function submitProposal() {
            const userName = document.getElementById('user-name').value || 'åŒ¿åçµ„å“¡';
            const proposalText = document.getElementById('proposal-input').value.trim();
            const userInputTopic = document.getElementById('user-input-topic').value.trim(); // é¡å¤–çš„æ¨™é¡Œæ¬„ä½

            if (!proposalText) {
                alert('ææ¡ˆå…§å®¹ä¸èƒ½ç‚ºç©ºï¼');
                return;
            }
            
            // å°‡ææ¡ˆæ¨™é¡Œå’Œå…§å®¹åˆä½µï¼Œä½¿ææ¡ˆæ›´å…·é«”
            const combinedProposal = userInputTopic ? `ã€${userInputTopic}ã€‘ ${proposalText}` : proposalText;

            try {
                const response = await fetch('/submit_proposal', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_name: userName,
                        proposal_text: combinedProposal
                    })
                });

                const result = await response.json();
                if (result.success) {
                    alert('ææ¡ˆæäº¤æˆåŠŸï¼');
                    document.getElementById('proposal-input').value = ''; 
                    document.getElementById('user-input-topic').value = '';
                    getProposals(); 
                } else {
                    alert(`æäº¤å¤±æ•—: ${result.message}`);
                }
            } catch (error) {
                console.error('Error submitting proposal:', error);
                alert('ç¶²è·¯éŒ¯èª¤ï¼Œææ¡ˆæäº¤å¤±æ•—ã€‚');
            }
        }

        /**
         * å¾å¾Œç«¯å–å¾—æ‰€æœ‰ææ¡ˆä¸¦æ›´æ–°åˆ—è¡¨
         */
        async function getProposals() {
            try {
                const response = await fetch('/get_proposals');
                const data = await response.json();
                const proposalList = document.getElementById('proposal-list');
                proposalList.innerHTML = ''; 

                if (data.proposals && data.proposals.length > 0) {
                    data.proposals.forEach(p => {
                        const li = document.createElement('li');
                        li.textContent = `[${p.timestamp.substring(11, 16)}] ${p.user_name}: ${p.proposal_text}`;
                        proposalList.appendChild(li);
                    });
                } else {
                    proposalList.innerHTML = '<li>ç›®å‰æ²’æœ‰ä»»ä½•ææ¡ˆã€‚</li>';
                }
                
                proposalCount = data.proposals.length;

            } catch (error) {
                console.error('Error fetching proposals:', error);
            }
        }

        /**
         * èª¿ç”¨ API å–å¾— Gemini åˆ†æçµæœ
         */
        async function getAnalysis(showLoading = true) {
            const output = document.getElementById('analysis-output');
            if (showLoading) {
                output.textContent = 'æ­£åœ¨å‘¼å« Gemini-2.5-Flash é€²è¡Œåˆ†æä¸­ï¼Œè«‹ç¨å€™...';
            }
            
            try {
                const response = await fetch('/get_analysis');
                const data = await response.json();

                if (response.ok) {
                    output.textContent = data.analysis;
                } else {
                    output.textContent = `åˆ†æå¤±æ•—: ${data.analysis || 'ä¼ºæœå™¨éŒ¯èª¤'}`;
                }
            } catch (error) {
                console.error('Error fetching analysis:', error);
                output.textContent = 'ç¶²è·¯éŒ¯èª¤ï¼Œç„¡æ³•é€£ç·šåˆ°åˆ†æä¼ºæœå™¨ã€‚';
            }
        }

        /**
         * é‡ç½®æœƒè­° (æ¸…é™¤è³‡æ–™åº«ä¸­çš„ææ¡ˆä¸¦é—œé–‰æœƒè­°)
         */
        async function resetSession() {
            if (!confirm("ç¢ºå®šè¦çµæŸæœ¬æ¬¡æœƒè­°ä¸¦æ¸…é™¤æ‰€æœ‰ææ¡ˆå—ï¼Ÿæ­¤æ“ä½œå°‡å°å›ç™¼èµ·é é¢ã€‚")) {
                return;
            }
            try {
                const response = await fetch('/reset_session', {
                    method: 'POST'
                });
                const result = await response.json();
                alert(result.message);
                // é‡ç½®å¾Œå°å›ç™¼èµ·é é¢
                window.location.href = '/'; 
            } catch (error) {
                alert('é‡ç½®å¤±æ•—ã€‚');
            }
        }
        
        // é é¢åŠ è¼‰å®Œæˆå¾Œï¼ŒåŸ·è¡Œï¼š
        window.onload = () => {
            getTopic(); // è¼‰å…¥ä¸»é¡Œ
            getProposals(); // è¼‰å…¥ææ¡ˆ
        };

        // æ¯ 5 ç§’è‡ªå‹•æ›´æ–°ææ¡ˆåˆ—è¡¨
        setInterval(getProposals, 5000); 

    </script>
</body>
</html>